<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi AI Manager</title>
    <link rel="stylesheet" href="common_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Multi AI specific styles */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-height: 320px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .model-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        .model-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .model-checkbox {
            margin-right: 10px;
        }

        .model-name {
            font-weight: 600;
            flex-grow: 1;
        }

        .model-quantity {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .quantity-btn {
            width: 25px;
            height: 25px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            cursor: pointer;
        }

        .quantity-value {
            margin: 0 10px;
            min-width: 20px;
            text-align: center;
        }

        .responses-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .response-section {
            min-width: 300px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 15px;
            background: white;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #3498db;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }

        .response-content {
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
        }

        .prompt-section {
            margin-top: 20px;
        }

        .prompt-input {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .build-btn {
            background-color: #2ecc71;
        }

        .build-btn:hover {
            background-color: #27ae60;
        }

        .send-btn {
            background-color: #3498db;
        }

        .send-btn:hover {
            background-color: #2980b9;
        }
        .quantity-btn.plus, .quantity-btn.minus {
            background-color: #2980b9;
            padding: 0px 0px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .quantity-btn.plus:hover, .quantity-btn.minus:hover {
            background-color: #6da2bc;
        }
        .quantity-btn.plus:active, .quantity-btn.minus:active {
            border: 1px solid #686464;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Multi AI Manager</h1>
            <div class="user-info">
                <span id="userName">Loading user...</span>
                <span id="regionInfo" class="region-info"></span>
            </div>
        </header>

        <div class="content">
            <div class="main">
                <h2>Select AI Models</h2>
                <div class="models-grid" id="modelsGrid">
                    <!-- Models will be loaded here -->
                </div>

                <div class="action-buttons">
                    <button id="buildChatBtn" class="build-btn">Build Chat UI</button>
                </div>

                <div id="responsesArea" style="display: none;">
                    <h2>Model Responses</h2>
                    <div class="responses-container" id="responsesContainer">
                        <!-- Response sections will be added here -->
                    </div>

                    <div class="prompt-section">
                        <h3>Prompt</h3>
                        <textarea id="promptInput" class="prompt-input"
                            placeholder="Enter your prompt here..."></textarea>
                        <button id="sendPromptBtn" class="send-btn">Send to Selected Models</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader overlay -->
    <div id="loaderOverlay" class="loader-overlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <script>
        // DOM Elements
        const modelsGrid = document.getElementById('modelsGrid');
        const buildChatBtn = document.getElementById('buildChatBtn');
        const responsesArea = document.getElementById('responsesArea');
        const responsesContainer = document.getElementById('responsesContainer');
        const promptInput = document.getElementById('promptInput');
        const sendPromptBtn = document.getElementById('sendPromptBtn');

        // State
        let allModels = [];
        let selectedModels = [];
        const MAX_SELECTED = 5;

        // Utility functions
        function showLoader() {
            document.getElementById('loaderOverlay').style.display = 'flex';
        }

        function hideLoader() {
            document.getElementById('loaderOverlay').style.display = 'none';
        }

        // Load models
        async function loadModels() {
            showLoader();
            try {
                const response = await fetch('/api/ai/models');
                if (!response.ok) throw new Error('Failed to load models');
                const models = await response.json();

                allModels = models;
                renderModels(models);
            } catch (error) {
                console.error('Error loading models:', error);
                modelsGrid.innerHTML = '<div class="error">Error loading models</div>';
            } finally {
                hideLoader();
            }
        }

        // Render models in grid
        function renderModels(models) {
            modelsGrid.innerHTML = '';

            models.forEach(model => {
                const modelCard = document.createElement('div');
                modelCard.className = 'model-card';
                modelCard.innerHTML = `
                    <div class="model-header">
                        <input type="checkbox" class="model-checkbox" id="model-${model.modelId}" 
                               data-model='${JSON.stringify(model)}'>
                        <label for="model-${model.modelId}" class="model-name" title="${model.modelId}">${model.modelName}</label>
                    </div>
                    <p>Provider: ${model.providerName}</p>
                    <div class="model-quantity">
                        <button class="quantity-btn minus" data-model="${model.modelId}">-</button>
                        <span class="quantity-value" data-model="${model.modelId}">1</span>
                        <button class="quantity-btn plus" data-model="${model.modelId}">+</button>
                    </div>
                `;
                modelsGrid.appendChild(modelCard);
            });

            // Add event listeners
            document.querySelectorAll('.model-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleModelSelection);
            });

            document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
                btn.addEventListener('click', increaseQuantity);
            });

            document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
                btn.addEventListener('click', decreaseQuantity);
            });
        }

        // Handle model selection
        function handleModelSelection(e) {
            const modelData = JSON.parse(e.target.dataset.model);
            const modelId = modelData.modelId;

            if (e.target.checked) {
                if (selectedModels.length >= MAX_SELECTED) {
                    e.target.checked = false;
                    alert(`Maximum ${MAX_SELECTED} models can be selected`);
                    return;
                }
                selectedModels.push({
                    ...modelData,
                    quantity: 1,
                    enabled: true
                });
            } else {
                selectedModels = selectedModels.filter(m => m.modelId !== modelId);
            }

            buildChatBtn.disabled = selectedModels.length === 0;
        }

        // Handle quantity changes
        function increaseQuantity(e) {
            const modelId = e.target.dataset.model;
            const quantityElement = document.querySelector(`.quantity-value[data-model="${modelId}"]`);
            let quantity = parseInt(quantityElement.textContent);

            if (quantity < 5) { // Max 5 instances per model
                quantity++;
                quantityElement.textContent = quantity;

                // Update selected models
                const modelIndex = selectedModels.findIndex(m => m.modelId === modelId);
                if (modelIndex !== -1) {
                    selectedModels[modelIndex].quantity = quantity;
                }
            }
        }

        function decreaseQuantity(e) {
            const modelId = e.target.dataset.model;
            const quantityElement = document.querySelector(`.quantity-value[data-model="${modelId}"]`);
            let quantity = parseInt(quantityElement.textContent);

            if (quantity > 1) {
                quantity--;
                quantityElement.textContent = quantity;

                // Update selected models
                const modelIndex = selectedModels.findIndex(m => m.modelId === modelId);
                if (modelIndex !== -1) {
                    selectedModels[modelIndex].quantity = quantity;
                }
            }
        }

        // Build chat UI
        // Build chat UI
        function buildChatUI() {
            if (selectedModels.length >= MAX_SELECTED) {
                    e.target.checked = false;
                    alert(`Maximum ${MAX_SELECTED} models can be selected`);
                    return;
            }
            responsesContainer.innerHTML = '';

            selectedModels.forEach(model => {
                // Create a section for each instance (not showing quantity)
                for (let i = 0; i < model.quantity; i++) {
                    const responseSection = document.createElement('div');
                    responseSection.className = 'response-section';
                    responseSection.innerHTML = `
                <div class="response-header">
                    <h4>${model.modelName}</h4>
                    <label class="toggle-switch">
                        <input type="checkbox" checked data-model="${model.modelId}" data-instance="${i}">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="response-content" id="response-${model.modelId}-${i}">
                    <!-- Responses will appear here -->
                </div>
            `;
                    responsesContainer.appendChild(responseSection);
                }
            });

            responsesArea.style.display = 'block';
        }

        // Send prompt to selected models
        // Send prompt to selected models
        async function sendPrompt() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }

            showLoader();

            try {
                // Create array of all instances (not just models)
                const instancesToQuery = [];
                selectedModels.forEach(model => {
                    for (let i = 0; i < model.quantity; i++) {
                        const toggle = document.querySelector(`.toggle-switch input[data-model="${model.modelId}"][data-instance="${i}"]`);
                        if (toggle && toggle.checked) {
                            instancesToQuery.push({
                                modelId: model.modelId,
                                instanceNum: i
                            });
                        }
                    }
                });

                if (instancesToQuery.length === 0) {
                    alert('No model instances enabled for this prompt');
                    return;
                }

                // Send to each enabled instance
                const promises = instancesToQuery.map(instance => {
                    return fetch('/api/ai/invoke', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            modelId: instance.modelId,
                            prompt: prompt
                        })
                    }).then(response => response.json())
                        .then(result => ({
                            ...result,
                            modelId: instance.modelId,
                            instanceNum: instance.instanceNum
                        }));
                });

                const results = await Promise.all(promises);

                // Display responses
                results.forEach(result => {
                    const responseElement = document.getElementById(`response-${result.modelId}-${result.instanceNum}`);
                    responseElement.innerHTML += `
                <div class="response-item">
                    <p><strong>Prompt:</strong> ${prompt}</p>
                    <p><strong>Response:</strong> ${result.response}</p>
                    <hr>
                </div>
            `;
                });

            } catch (error) {
                console.error('Error sending prompt:', error);
                alert(`Error: ${error.message}`);
            } finally {
                hideLoader();
            }
        }

        // Event listeners
        buildChatBtn.addEventListener('click', buildChatUI);
        sendPromptBtn.addEventListener('click', sendPrompt);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            loadRegionInfo();
            loadModels();
        });

        // Reuse these functions from other pages
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user');
                if (!response.ok) throw new Error('Failed to load user info');
                const user = await response.json();

                let displayName = user.arn;
                if (user.userName) {
                    displayName = user.userName;
                } else if (user.arn.includes('assumed-role')) {
                    displayName = user.arn.split('/').slice(1).join('/');
                }

                document.getElementById('userName').textContent = displayName;
                document.getElementById('userName').title = `ARN: ${user.arn}\nAccount: ${user.account}\nUser ID: ${user.userId}`;
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('userName').textContent = 'Unknown user';
            }
        }

        async function loadRegionInfo() {
            try {
                const response = await fetch('/api/region');
                if (!response.ok) throw new Error('Failed to load region info');
                const region = await response.json();

                const regionElement = document.getElementById('regionInfo');
                regionElement.textContent = `Region: ${region.region}`;
                if (region.isDefault) {
                    regionElement.title = 'Using default region (us-east-1)';
                } else {
                    regionElement.title = 'Configured region';
                }
            } catch (error) {
                console.error('Error loading region info:', error);
                document.getElementById('regionInfo').textContent = 'Region: Unknown';
            }
        }
    </script>
</body>

</html>